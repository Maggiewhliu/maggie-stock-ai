name: Maggie Stock AI - Unified System

on:
  # ä¸ƒå·¨é ­è‡ªå‹•å ±å‘Š - æ¯æ—¥4æ¬¡
  schedule:
    # 06:00 å°åŒ—æ™‚é–“ = 22:00 UTC (å‰ä¸€å¤©)
    - cron: '0 22 * * *'
    # 12:00 å°åŒ—æ™‚é–“ = 04:00 UTC  
    - cron: '0 4 * * *'
    # 18:00 å°åŒ—æ™‚é–“ = 10:00 UTC
    - cron: '0 10 * * *'
    # 22:00 å°åŒ—æ™‚é–“ = 14:00 UTC
    - cron: '0 14 * * *'
  
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      mode:
        description: 'åŸ·è¡Œæ¨¡å¼'
        required: true
        default: 'auto_report'
        type: choice
        options:
        - auto_report
        - welcome_message
        - user_demo
        
  # Pushæ™‚è§¸ç™¼ (æ¸¬è©¦ç”¨)
  push:
    branches: [ main ]

jobs:
  maggie-stock-ai:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests python-dateutil
    
    - name: ğŸ• Display current time
      run: |
        echo "ğŸŒ UTC Time: $(date -u)"
        echo "ğŸ‡¹ğŸ‡¼ Taipei Time: $(TZ='Asia/Taipei' date)"
        echo "â° Current Hour (Taipei): $(TZ='Asia/Taipei' date +%H)"
    
    - name: ğŸ¤– Run Maggie Stock AI System
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        EXECUTION_MODE: ${{ github.event.inputs.mode || 'auto_report' }}
      run: |
        TAIPEI_HOUR=$(TZ='Asia/Taipei' date +%H)
        MODE="${EXECUTION_MODE}"
        
        echo "ğŸ¤– Maggie Stock AI çµ±ä¸€ç³»çµ±å•Ÿå‹•"
        echo "ğŸ“Š æ”¯æ´åŠŸèƒ½: å…è²»æŸ¥è©¢ + Pro Beta + ä¸ƒå·¨é ­å ±å‘Š"
        echo "â° å°åŒ—æ™‚é–“: $(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M')"
        echo "ğŸ¯ åŸ·è¡Œæ¨¡å¼: ${MODE}"
        
        if [ "$MODE" = "auto_report" ]; then
          if [ "$TAIPEI_HOUR" -ge 5 ] && [ "$TAIPEI_HOUR" -lt 11 ]; then
            echo "ğŸŒ… åŸ·è¡Œ: ç›¤å‰åˆ†æå ±å‘Š"
          elif [ "$TAIPEI_HOUR" -ge 11 ] && [ "$TAIPEI_HOUR" -lt 17 ]; then
            echo "ğŸŒ åŸ·è¡Œ: é–‹ç›¤å ±å‘Š"
          elif [ "$TAIPEI_HOUR" -ge 17 ] && [ "$TAIPEI_HOUR" -lt 23 ]; then
            echo "ğŸŒ† åŸ·è¡Œ: æ”¶ç›¤ç¸½çµ"
          else
            echo "ğŸŒ™ åŸ·è¡Œ: ç›¤å¾Œå¤œå ±"
          fi
        elif [ "$MODE" = "welcome_message" ]; then
          echo "ğŸ‘‹ åŸ·è¡Œ: ç™¼é€æ­¡è¿æ¶ˆæ¯"
        else
          echo "ğŸ§ª åŸ·è¡Œ: ç”¨æˆ¶æ¼”ç¤ºæ¨¡å¼"
        fi
        
        echo "=" | tr = "="
        python maggie_stock_ai.py
    
    - name: ğŸ“Š Log execution results
      run: |
        TAIPEI_TIME=$(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M')
        CURRENT_HOUR=$(TZ='Asia/Taipei' date +%H)
        
        if [ "$CURRENT_HOUR" -ge 5 ] && [ "$CURRENT_HOUR" -lt 11 ]; then
          NEXT_REPORT="12:00 é–‹ç›¤å ±å‘Š"
        elif [ "$CURRENT_HOUR" -ge 11 ] && [ "$CURRENT_HOUR" -lt 17 ]; then
          NEXT_REPORT="18:00 æ”¶ç›¤ç¸½çµ"
        elif [ "$CURRENT_HOUR" -ge 17 ] && [ "$CURRENT_HOUR" -lt 23 ]; then
          NEXT_REPORT="22:00 ç›¤å¾Œå¤œå ±"
        else
          NEXT_REPORT="æ˜æ—¥ 06:00 ç›¤å‰åˆ†æ"
        fi
        
        echo "âœ… Maggie Stock AI åŸ·è¡Œå®Œæˆ"
        echo "ğŸ“… å®Œæˆæ™‚é–“: ${TAIPEI_TIME}"
        echo "ğŸ”„ ä¸‹æ¬¡è‡ªå‹•å ±å‘Š: ${NEXT_REPORT}"
        echo "ğŸ¤– ç³»çµ±ç‹€æ…‹: æ­£å¸¸é‹è¡Œ"
        echo "ğŸ‘¥ æ”¯æ´ç”¨æˆ¶: å…è²»ç‰ˆ + Pro Beta(100äºº) + VIP"
    
    - name: ğŸ‰ Success notification
      if: success()
      run: |
        echo "ğŸ¯ Maggie Stock AI ç³»çµ±é‹è¡ŒæˆåŠŸï¼"
        echo "ğŸ“Š åŠŸèƒ½ç‹€æ…‹:"
        echo "   âœ… å…è²»ç‰ˆè‚¡ç¥¨æŸ¥è©¢"
        echo "   âœ… Pro Beta ä¸ƒå·¨é ­åˆ†æ"  
        echo "   âœ… è‡ªå‹•å ±å‘Šæ¨é€"
        echo "   âœ… ç”¨æˆ¶æ¬Šé™ç®¡æ§"
        echo "ğŸš€ ç³»çµ±å·²æº–å‚™æ¥æ”¶ç”¨æˆ¶æŸ¥è©¢"
    
    - name: âŒ Failure notification
      if: failure()
      run: |
        echo "âš ï¸ Maggie Stock AI ç³»çµ±åŸ·è¡Œå¤±æ•—"
        echo "ğŸ”§ è«‹æª¢æŸ¥ä»¥ä¸‹é …ç›®:"
        echo "   â€¢ Telegram Bot Token æ˜¯å¦æ­£ç¢º"
        echo "   â€¢ Chat ID æ˜¯å¦æœ‰æ•ˆ"
        echo "   â€¢ ç¶²è·¯é€£æ¥æ˜¯å¦æ­£å¸¸"
        echo "   â€¢ Yahoo Finance API æ˜¯å¦å¯ç”¨"
        echo "   â€¢ Python ä»£ç¢¼æ˜¯å¦æœ‰èªæ³•éŒ¯èª¤"
        echo "ğŸ“‹ è©³ç´°éŒ¯èª¤è«‹æŸ¥çœ‹ Actions æ—¥èªŒ"
