name: Maggie Stock AI - Unified System

on:
  # 七巨頭自動報告 - 每日4次
  schedule:
    # 06:00 台北時間 = 22:00 UTC (前一天)
    - cron: '0 22 * * *'
    # 12:00 台北時間 = 04:00 UTC  
    - cron: '0 4 * * *'
    # 18:00 台北時間 = 10:00 UTC
    - cron: '0 10 * * *'
    # 22:00 台北時間 = 14:00 UTC
    - cron: '0 14 * * *'
  
  # 手動觸發
  workflow_dispatch:
    inputs:
      mode:
        description: '執行模式'
        required: true
        default: 'auto_report'
        type: choice
        options:
        - auto_report
        - welcome_message
        - user_demo
        
  # Push時觸發 (測試用)
  push:
    branches: [ main ]

jobs:
  maggie-stock-ai:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout repository
      uses: actions/checkout@v4
    
    - name: 🐍 Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: 📦 Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests python-dateutil
    
    - name: 🕐 Display current time
      run: |
        echo "🌍 UTC Time: $(date -u)"
        echo "🇹🇼 Taipei Time: $(TZ='Asia/Taipei' date)"
        echo "⏰ Current Hour (Taipei): $(TZ='Asia/Taipei' date +%H)"
    
    - name: 🤖 Run Maggie Stock AI System
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        EXECUTION_MODE: ${{ github.event.inputs.mode || 'auto_report' }}
      run: |
        TAIPEI_HOUR=$(TZ='Asia/Taipei' date +%H)
        MODE="${EXECUTION_MODE}"
        
        echo "🤖 Maggie Stock AI 統一系統啟動"
        echo "📊 支援功能: 免費查詢 + Pro Beta + 七巨頭報告"
        echo "⏰ 台北時間: $(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M')"
        echo "🎯 執行模式: ${MODE}"
        
        if [ "$MODE" = "auto_report" ]; then
          if [ "$TAIPEI_HOUR" -ge 5 ] && [ "$TAIPEI_HOUR" -lt 11 ]; then
            echo "🌅 執行: 盤前分析報告"
          elif [ "$TAIPEI_HOUR" -ge 11 ] && [ "$TAIPEI_HOUR" -lt 17 ]; then
            echo "🌞 執行: 開盤報告"
          elif [ "$TAIPEI_HOUR" -ge 17 ] && [ "$TAIPEI_HOUR" -lt 23 ]; then
            echo "🌆 執行: 收盤總結"
          else
            echo "🌙 執行: 盤後夜報"
          fi
        elif [ "$MODE" = "welcome_message" ]; then
          echo "👋 執行: 發送歡迎消息"
        else
          echo "🧪 執行: 用戶演示模式"
        fi
        
        echo "=" | tr = "="
        python maggie_stock_ai.py
    
    - name: 📊 Log execution results
      run: |
        TAIPEI_TIME=$(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M')
        CURRENT_HOUR=$(TZ='Asia/Taipei' date +%H)
        
        if [ "$CURRENT_HOUR" -ge 5 ] && [ "$CURRENT_HOUR" -lt 11 ]; then
          NEXT_REPORT="12:00 開盤報告"
        elif [ "$CURRENT_HOUR" -ge 11 ] && [ "$CURRENT_HOUR" -lt 17 ]; then
          NEXT_REPORT="18:00 收盤總結"
        elif [ "$CURRENT_HOUR" -ge 17 ] && [ "$CURRENT_HOUR" -lt 23 ]; then
          NEXT_REPORT="22:00 盤後夜報"
        else
          NEXT_REPORT="明日 06:00 盤前分析"
        fi
        
        echo "✅ Maggie Stock AI 執行完成"
        echo "📅 完成時間: ${TAIPEI_TIME}"
        echo "🔄 下次自動報告: ${NEXT_REPORT}"
        echo "🤖 系統狀態: 正常運行"
        echo "👥 支援用戶: 免費版 + Pro Beta(100人) + VIP"
    
    - name: 🎉 Success notification
      if: success()
      run: |
        echo "🎯 Maggie Stock AI 系統運行成功！"
        echo "📊 功能狀態:"
        echo "   ✅ 免費版股票查詢"
        echo "   ✅ Pro Beta 七巨頭分析"  
        echo "   ✅ 自動報告推送"
        echo "   ✅ 用戶權限管控"
        echo "🚀 系統已準備接收用戶查詢"
    
    - name: ❌ Failure notification
      if: failure()
      run: |
        echo "⚠️ Maggie Stock AI 系統執行失敗"
        echo "🔧 請檢查以下項目:"
        echo "   • Telegram Bot Token 是否正確"
        echo "   • Chat ID 是否有效"
        echo "   • 網路連接是否正常"
        echo "   • Yahoo Finance API 是否可用"
        echo "   • Python 代碼是否有語法錯誤"
        echo "📋 詳細錯誤請查看 Actions 日誌"
