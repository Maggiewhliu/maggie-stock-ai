#!/usr/bin/env python3
"""
Maggie Stock AI - çµ±ä¸€è‚¡ç¥¨åˆ†ææ©Ÿå™¨äºº
æ”¯æ´ï¼šå…è²»ç‰ˆæŸ¥è©¢ + ä¸ƒå·¨é ­Proæ¸¬è©¦ + VIPå®Œæ•´åŠŸèƒ½
"""
import sys
import requests
import os
import json
import re
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Tuple

class UnifiedStockBot:
    def __init__(self):
        self.telegram_token = os.getenv('TELEGRAM_BOT_TOKEN')
        self.telegram_chat_id = os.getenv('TELEGRAM_CHAT_ID')
        
        # è‚¡ç¥¨é…ç½®
        self.sp500_symbols = self.load_sp500_list()
        self.magnificent_seven = ['AAPL', 'NVDA', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'META']
        
        # ç”¨æˆ¶ç³»çµ±é…ç½®
        self.user_levels = {
            'free': {'daily_limit': 3, 'stocks': 'sp500', 'features': 'basic'},
            'pro_beta': {'daily_limit': 999, 'stocks': 'magnificent7', 'features': 'advanced'},
            'vip': {'daily_limit': 999, 'stocks': 'all', 'features': 'premium'}
        }
        
        # ç”¨æˆ¶æ•¸æ“šåº« (å¯¦éš›æ‡‰ç”¨ä½¿ç”¨çœŸå¯¦æ•¸æ“šåº«)
        self.users = {}
        self.pro_beta_users = set()  # Proæ¸¬è©¦ç”¨æˆ¶ç™½åå–® (100äººé™åˆ¶)
        
        # è‚¡ç¥¨emojiæ˜ å°„
        self.stock_emojis = {
            'AAPL': 'ğŸ', 'NVDA': 'ğŸš€', 'MSFT': 'ğŸ’»', 'GOOGL': 'ğŸ”',
            'AMZN': 'ğŸ“¦', 'TSLA': 'ğŸš—', 'META': 'ğŸ“˜'
        }
        
        if not self.telegram_token:
            raise ValueError("ç¼ºå°‘ Telegram Bot Token")
    
    def load_sp500_list(self) -> List[str]:
        """åŠ è¼‰æ¨™æ™®500è‚¡ç¥¨æ¸…å–®"""
        return [
            'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'TSLA', 'META', 'BRK.B',
            'UNH', 'JNJ', 'V', 'PG', 'JPM', 'HD', 'MA', 'PFE', 'BAC', 'ABBV',
            'KO', 'PEP', 'COST', 'DIS', 'ADBE', 'CRM', 'NFLX', 'XOM', 'TMO',
            'VZ', 'ACN', 'DHR', 'LLY', 'NKE', 'QCOM', 'TXN', 'NEE', 'PM',
            'UPS', 'RTX', 'LOW', 'INTU', 'AMD', 'SPGI', 'HON', 'SBUX', 'GS',
            'CVX', 'LIN', 'T', 'UNP', 'SCHW', 'AXP', 'BLK', 'MDT', 'CAT'
        ]
    
    def register_user(self, user_id: str, level: str = 'free') -> Dict:
        """è¨»å†Šæ–°ç”¨æˆ¶"""
        self.users[user_id] = {
            'level': level,
            'daily_queries': 0,
            'total_queries': 0,
            'last_reset': datetime.now().date(),
            'joined_date': datetime.now(),
            'last_query_time': None
        }
        return self.users[user_id]
    
    def get_user_info(self, user_id: str) -> Dict:
        """ç²å–ç”¨æˆ¶ä¿¡æ¯"""
        if user_id not in self.users:
            self.register_user(user_id)
        
        user = self.users[user_id]
        
        # é‡ç½®æ¯æ—¥è¨ˆæ•¸
        if user['last_reset'] != datetime.now().date():
            user['daily_queries'] = 0
            user['last_reset'] = datetime.now().date()
        
        return user
    
    def check_query_permission(self, user_id: str, symbol: str) -> Tuple[bool, str]:
        """æª¢æŸ¥ç”¨æˆ¶æŸ¥è©¢æ¬Šé™"""
        user = self.get_user_info(user_id)
        user_config = self.user_levels[user['level']]
        
        # æª¢æŸ¥æ¯æ—¥é™åˆ¶
        if user['daily_queries'] >= user_config['daily_limit']:
            return False, self.generate_upgrade_message('daily_limit')
        
        # æª¢æŸ¥è‚¡ç¥¨æ¬Šé™
        symbol = symbol.upper()
        if user_config['stocks'] == 'sp500' and symbol not in self.sp500_symbols:
            return False, self.generate_upgrade_message('stock_limit')
        elif user_config['stocks'] == 'magnificent7' and symbol not in self.magnificent_seven:
            return False, f"ğŸš« Pro Betaç‰ˆåƒ…æ”¯æŒä¸ƒå·¨é ­è‚¡ç¥¨\nğŸ’ å‡ç´šVIPè§£é–å…¨ç¾è‚¡8000+æ”¯ï¼"
        
        return True, "OK"
    
    def generate_upgrade_message(self, trigger_type: str) -> str:
        """ç”Ÿæˆå‡ç´šæ¨å»£ä¿¡æ¯"""
        if trigger_type == 'daily_limit':
            return """
ğŸš« **å…è²»ç‰ˆæ¯æ—¥æŸ¥è©¢å·²é”ä¸Šé™ (3æ¬¡)**

ğŸ’ **å‡ç´šè§£é–æ›´å¤šåŠŸèƒ½ï¼**

ğŸ¥ˆ **Pro Beta (é™æ™‚å…è²»)**:
âœ… ä¸ƒå·¨é ­è‚¡ç¥¨ç„¡é™æŸ¥è©¢
âœ… Max Pain/Gamma å°ˆæ¥­åˆ†æ
âœ… æ¯æ—¥4æ¬¡è‡ªå‹•å ±å‘Š
âœ… åƒ…é™100äººæ¸¬è©¦

ğŸ¥‡ **VIPå°ˆæ¥­ç‰ˆ $49.99/æœˆ**:
âœ… å…¨ç¾è‚¡8000+æ”¯æŸ¥è©¢
âœ… æœŸæ¬Šæ·±åº¦åˆ†æ
âœ… ç±Œç¢¼åˆ†æ
âœ… Notioné¢æ¿æ•´åˆ
âœ… åƒ¹æ ¼è­¦å ±

ç”³è«‹Pro Beta: /apply_beta
ç«‹å³å‡ç´šVIP: [å‡ç´šé€£çµ]
"""
        elif trigger_type == 'stock_limit':
            return """
ğŸš« **è©²è‚¡ç¥¨ä¸åœ¨å…è²»ç‰ˆç¯„åœå…§**

å…è²»ç‰ˆåƒ…æ”¯æŒæ¨™æ™®500è‚¡ç¥¨ã€‚

ğŸ’¡ **å‡ç´šé¸é …**:
ğŸ¥ˆ Pro Beta: ä¸ƒå·¨é ­æ·±åº¦åˆ†æ (å…è²»æ¸¬è©¦)
ğŸ¥‡ VIPç‰ˆ: å…¨ç¾è‚¡ç„¡é™æŸ¥è©¢

ç”³è«‹Pro Beta: /apply_beta
æŸ¥çœ‹æ¨™æ™®500æ¸…å–®: /sp500
"""
    
    def apply_for_beta(self, user_id: str) -> str:
        """ç”³è«‹Pro Betaæ¸¬è©¦"""
        if len(self.pro_beta_users) >= 100:
            return """
ğŸ˜¢ **Pro Betaæ¸¬è©¦åé¡å·²æ»¿ (100/100)**

ä½†æ‚¨å¯ä»¥ï¼š
ğŸ’ åŠ å…¥VIPç‰ˆç­‰å€™åå–®ï¼Œäº«æ—©é³¥5æŠ˜å„ªæƒ 
ğŸ”” æˆ‘å€‘æœƒåœ¨æœ‰åé¡æ™‚å„ªå…ˆé€šçŸ¥æ‚¨

åŠ å…¥ç­‰å€™åå–®: /waitlist
ç›´æ¥å‡ç´šVIP: /upgrade
"""
        
        if user_id in self.pro_beta_users:
            return "âœ… æ‚¨å·²ç¶“æ˜¯Pro Betaæ¸¬è©¦ç”¨æˆ¶äº†ï¼"
        
        # æ·»åŠ åˆ°Pro Betaç”¨æˆ¶
        self.pro_beta_users.add(user_id)
        self.users[user_id]['level'] = 'pro_beta'
        
        return f"""
ğŸ‰ **æ­å–œï¼Pro Betaç”³è«‹æˆåŠŸï¼**

æ‚¨ç¾åœ¨å¯ä»¥äº«å—ï¼š
âœ… ä¸ƒå·¨é ­è‚¡ç¥¨ç„¡é™æŸ¥è©¢
âœ… Max Pain/Gamma å°ˆæ¥­åˆ†æ  
âœ… æ¯æ—¥4æ¬¡è‡ªå‹•å ±å‘Š
âœ… 30å¤©å…è²»æ¸¬è©¦

ğŸš€ **ä¸ƒå·¨é ­è‚¡ç¥¨**: AAPL, NVDA, MSFT, GOOGL, AMZN, TSLA, META

ğŸ’¡ **ä½¿ç”¨æ–¹æ³•**:
ç›´æ¥è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼Œä¾‹å¦‚ï¼šAAPL

ğŸ‘¥ **æ¸¬è©¦ç¾¤çµ„**: {len(self.pro_beta_users)}/100äºº
â° **æ¸¬è©¦æœŸé™**: 30å¤©

é–‹å§‹é«”é©—å§ï¼ğŸ¯
"""
    
    def get_stock_data(self, symbol: str) -> Dict:
        """ç²å–è‚¡ç¥¨æ•¸æ“š"""
        try:
            url = f"https://query1.finance.yahoo.com/v8/finance/chart/{symbol}"
            headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}
            
            response = requests.get(url, headers=headers, timeout=10)
            data = response.json()
            
            if not data.get('chart') or not data['chart'].get('result'):
                return {'error': 'è‚¡ç¥¨ä»£ç¢¼ç„¡æ•ˆæˆ–æ•¸æ“šä¸å¯ç”¨'}
            
            result = data['chart']['result'][0]
            meta = result['meta']
            
            # åŸºç¤æ•¸æ“š
            current_price = meta['regularMarketPrice']
            previous_close = meta['previousClose']
            change = current_price - previous_close
            change_percent = (change / previous_close) * 100
            
            return {
                'symbol': symbol,
                'company_name': meta.get('longName', symbol),
                'current_price': current_price,
                'previous_close': previous_close,
                'change': change,
                'change_percent': change_percent,
                'volume': meta.get('regularMarketVolume', 0),
                'market_cap': meta.get('marketCap'),
                'day_high': meta.get('regularMarketDayHigh'),
                'day_low': meta.get('regularMarketDayLow'),
                'status_emoji': self.get_status_emoji(change_percent)
            }
        except Exception as e:
            return {'error': f'æ•¸æ“šç²å–å¤±æ•—: {str(e)}'}
    
    def get_status_emoji(self, change_percent: float) -> str:
        """ç²å–ç‹€æ…‹emoji"""
        if change_percent >= 2:
            return 'ğŸ”¥'
        elif change_percent >= 0.5:
            return 'ğŸ“ˆ'
        elif change_percent >= 0:
            return 'ğŸ“Š'
        elif change_percent >= -0.5:
            return 'ğŸ“‰'
        else:
            return 'ğŸ’¥'
    
    def calculate_max_pain(self, symbol: str, current_price: float) -> Dict:
        """è¨ˆç®—Max Pain (ProåŠŸèƒ½)"""
        # æ¨¡æ“¬Max Painè¨ˆç®—
        adjustments = {
            'AAPL': 0.985, 'NVDA': 0.975, 'MSFT': 0.988,
            'GOOGL': 0.982, 'AMZN': 0.978, 'TSLA': 0.970, 'META': 0.980
        }
        
        max_pain_price = current_price * adjustments.get(symbol, 0.98)
        distance = abs(current_price - max_pain_price)
        distance_percent = (distance / current_price) * 100
        
        if distance_percent < 1:
            strength = "ğŸ”´ æ¥µå¼·ç£å¸"
        elif distance_percent < 2:
            strength = "ğŸŸ¡ ä¸­ç­‰ç£å¸"
        else:
            strength = "ğŸŸ¢ å¼±ç£å¸"
        
        return {
            'max_pain_price': max_pain_price,
            'distance': distance,
            'strength': strength
        }
    
    def calculate_gamma_levels(self, symbol: str, current_price: float) -> Dict:
        """è¨ˆç®—Gammaæ”¯æ’é˜»åŠ› (ProåŠŸèƒ½)"""
        ranges = {
            'AAPL': 0.06, 'NVDA': 0.08, 'MSFT': 0.05,
            'GOOGL': 0.06, 'AMZN': 0.07, 'TSLA': 0.10, 'META': 0.06
        }
        
        range_factor = ranges.get(symbol, 0.06)
        support = current_price * (1 - range_factor)
        resistance = current_price * (1 + range_factor)
        
        return {
            'support': support,
            'resistance': resistance
        }
    
    def generate_ai_recommendation(self, symbol: str, stock_data: Dict, user_level: str) -> Dict:
        """ç”ŸæˆAIå»ºè­°å’Œä¿¡å¿ƒåº¦"""
        change_pct = stock_data['change_percent']
        price = stock_data['current_price']
        
        # åŸºç¤å»ºè­°é‚è¼¯
        if change_pct > 3:
            recommendation = "å¼·å‹¢çªç ´ï¼Œå¯è€ƒæ…®è¿½æ¼²"
            confidence = 85
            strategy = "çŸ­ç·šçœ‹æ¼²"
        elif change_pct > 1:
            recommendation = "æº«å’Œä¸Šæ¼²ï¼Œè¬¹æ…æ¨‚è§€"
            confidence = 70
            strategy = "æŒçºŒè§€å¯Ÿ"
        elif change_pct > -1:
            recommendation = "éœ‡ç›ªæ•´ç†ï¼Œç­‰å¾…æ–¹å‘"
            confidence = 60
            strategy = "è§€æœ›ç‚ºä¸»"
        elif change_pct > -3:
            recommendation = "èª¿æ•´å£“åŠ›ï¼Œé€¢ä½å¸ƒå±€"
            confidence = 65
            strategy = "åˆ†æ‰¹é€²å ´"
        else:
            recommendation = "æ·±åº¦èª¿æ•´ï¼Œé¢¨éšªè¼ƒé«˜"
            confidence = 45
            strategy = "è¬¹æ…è§€æœ›"
        
        # Proç”¨æˆ¶æœ‰æ›´è©³ç´°çš„åˆ†æ
        if user_level in ['pro_beta', 'vip']:
            max_pain = self.calculate_max_pain(symbol, price)
            gamma = self.calculate_gamma_levels(symbol, price)
            
            # åŸºæ–¼Max Painèª¿æ•´å»ºè­°
            if max_pain['strength'] == "ğŸ”´ æ¥µå¼·ç£å¸":
                recommendation += f"ï¼Œæ³¨æ„Max Painç£å¸æ•ˆæ‡‰"
                confidence -= 10
        
        return {
            'recommendation': recommendation,
            'confidence': max(min(confidence, 95), 30),
            'strategy': strategy
        }
    
    def format_stock_response(self, symbol: str, stock_data: Dict, user_info: Dict) -> str:
        """æ ¼å¼åŒ–è‚¡ç¥¨å›æ‡‰"""
        if 'error' in stock_data:
            return f"âŒ {stock_data['error']}"
        
        user_level = user_info['level']
        emoji = self.stock_emojis.get(symbol, 'ğŸ“Š')
        
        # åŸºç¤ä¿¡æ¯
        response = f"""
{emoji} **{stock_data['company_name']} ({symbol})**

ğŸ’° **å³æ™‚åƒ¹æ ¼** (å»¶é²3-5åˆ†é˜)
ç•¶å‰: ${stock_data['current_price']:.2f}
æ¼²è·Œ: {stock_data['change']:+.2f} ({stock_data['change_percent']:+.2f}%) {stock_data['status_emoji']}
æˆäº¤é‡: {stock_data['volume']:,}
"""
        
        # åƒ¹æ ¼å€é–“
        if stock_data.get('day_high') and stock_data.get('day_low'):
            response += f"""
ğŸ“ˆ **ä»Šæ—¥å€é–“**
æœ€é«˜: ${stock_data['day_high']:.2f}
æœ€ä½: ${stock_data['day_low']:.2f}
"""
        
        # AIå»ºè­° (æ‰€æœ‰ç”¨æˆ¶éƒ½æœ‰)
        ai_rec = self.generate_ai_recommendation(symbol, stock_data, user_level)
        response += f"""
ğŸ¤– **AIåˆ†æå»ºè­°**
æ¨è–¦: {ai_rec['recommendation']}
ç­–ç•¥: {ai_rec['strategy']}
ä¿¡å¿ƒåº¦: {ai_rec['confidence']}% {'ğŸ”¥' if ai_rec['confidence'] > 80 else 'ğŸ“Š' if ai_rec['confidence'] > 60 else 'âš ï¸'}
"""
        
        # ProåŠŸèƒ½ (Max Pain + Gamma)
        if user_level in ['pro_beta', 'vip']:
            max_pain = self.calculate_max_pain(symbol, stock_data['current_price'])
            gamma = self.calculate_gamma_levels(symbol, stock_data['current_price'])
            
            response += f"""
ğŸ§² **Max Painåˆ†æ** (ProåŠŸèƒ½)
ç›®æ¨™åƒ¹: ${max_pain['max_pain_price']:.2f}
ç£å¸å¼·åº¦: {max_pain['strength']}
è·é›¢: ${max_pain['distance']:.2f}

âš¡ **Gammaæ”¯æ’é˜»åŠ›** (ProåŠŸèƒ½)  
æ”¯æ’ä½: ${gamma['support']:.2f}
é˜»åŠ›ä½: ${gamma['resistance']:.2f}
"""
        
        # ç”¨æˆ¶ç‹€æ…‹
        remaining = self.user_levels[user_level]['daily_limit'] - user_info['daily_queries'] - 1
        if user_level == 'free':
            response += f"""
ğŸ“± **å…è²»ç‰ˆç‹€æ…‹**
å‰©é¤˜æŸ¥è©¢: {remaining}æ¬¡
å‡ç´šPro Beta: /apply_beta
"""
        elif user_level == 'pro_beta':
            response += f"""
ğŸ’ **Pro Betaç‹€æ…‹**
ç„¡é™æŸ¥è©¢ | ä¸ƒå·¨é ­å°ˆäº«
æ¸¬è©¦å‰©é¤˜: {30 - (datetime.now().date() - user_info['joined_date'].date()).days}å¤©
"""
        
        # å‡ç´šèª˜å›  (å…è²»ç”¨æˆ¶)
        if user_level == 'free':
            if remaining <= 0:
                response += "\n" + self.generate_upgrade_message('daily_limit')
            elif remaining == 1:
                response += f"""
ğŸ’¡ **æé†’**: ä»Šæ—¥æœ€å¾Œ1æ¬¡æŸ¥è©¢
Pro Betaå…è²»æ¸¬è©¦: /apply_beta
"""
        
        return response
    
    def process_message(self, message: str, user_id: str) -> str:
        """è™•ç†ç”¨æˆ¶æ¶ˆæ¯"""
        message = message.strip()
        
        # æŒ‡ä»¤è™•ç†
        if message.startswith('/'):
            return self.handle_command(message, user_id)
        
        # è‚¡ç¥¨ä»£ç¢¼æª¢æ¸¬
        symbol_match = re.match(r'^[A-Za-z]{1,5}$', message)
        if symbol_match:
            symbol = message.upper()
            return self.query_stock(symbol, user_id)
        
        # é è¨­å›æ‡‰
        return """
â“ **ä½¿ç”¨æ–¹æ³•**:
ç›´æ¥è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼Œä¾‹å¦‚ï¼š
â€¢ AAPL (è˜‹æœ)
â€¢ TSLA (ç‰¹æ–¯æ‹‰)
â€¢ NVDA (è‹±å‰é”)

ğŸ“‹ **æŒ‡ä»¤æ¸…å–®**:
/help - ä½¿ç”¨èªªæ˜
/apply_beta - ç”³è«‹Pro Beta
/status - æŸ¥çœ‹ç‹€æ…‹

ğŸ’¡ æ”¯æŒçš„è‚¡ç¥¨ä»£ç¢¼: A-Zï¼Œ1-5å€‹å­—æ¯
"""
    
    def handle_command(self, command: str, user_id: str) -> str:
        """è™•ç†æŒ‡ä»¤"""
        if command == '/start' or command == '/help':
            return self.generate_welcome_message()
        elif command == '/apply_beta':
            return self.apply_for_beta(user_id)
        elif command == '/status':
            return self.get_user_status(user_id)
        elif command == '/sp500':
            return f"ğŸ“Š **æ¨™æ™®500è‚¡ç¥¨æ¸…å–®**:\n{', '.join(self.sp500_symbols[:50])}...\n\nå…±500æ”¯è‚¡ç¥¨ï¼Œå…è²»ç‰ˆå…¨éƒ¨æ”¯æŒï¼"
        else:
            return "â“ æœªçŸ¥æŒ‡ä»¤ï¼Œè¼¸å…¥ /help æŸ¥çœ‹ä½¿ç”¨èªªæ˜"
    
    def query_stock(self, symbol: str, user_id: str) -> str:
        """è‚¡ç¥¨æŸ¥è©¢ä¸»å‡½æ•¸"""
        # æª¢æŸ¥æ¬Šé™
        can_query, message = self.check_query_permission(user_id, symbol)
        if not can_query:
            return message
        
        # ç²å–è‚¡ç¥¨æ•¸æ“š
        stock_data = self.get_stock_data(symbol)
        if 'error' in stock_data:
            return f"âŒ {stock_data['error']}\n\nè«‹ç¢ºèªè‚¡ç¥¨ä»£ç¢¼æ­£ç¢º"
        
        # æ›´æ–°ç”¨æˆ¶æŸ¥è©¢è¨ˆæ•¸
        user_info = self.get_user_info(user_id)
        user_info['daily_queries'] += 1
        user_info['total_queries'] += 1
        user_info['last_query_time'] = datetime.now()
        
        # æ ¼å¼åŒ–å›æ‡‰
        return self.format_stock_response(symbol, stock_data, user_info)
    
    def get_user_status(self, user_id: str) -> str:
        """ç²å–ç”¨æˆ¶ç‹€æ…‹"""
        user = self.get_user_info(user_id)
        level_config = self.user_levels[user['level']]
        
        level_names = {
            'free': 'ğŸ†“ å…è²»ç‰ˆ',
            'pro_beta': 'ğŸ’ Pro Beta',
            'vip': 'ğŸ”¥ VIPå°ˆæ¥­ç‰ˆ'
        }
        
        return f"""
ğŸ‘¤ **ç”¨æˆ¶ç‹€æ…‹å ±å‘Š**

ğŸ“Š **è¨‚é–±ç´šåˆ¥**: {level_names[user['level']]}
ğŸ“ˆ **ä»Šæ—¥æŸ¥è©¢**: {user['daily_queries']}/{level_config['daily_limit']}
ğŸ“± **ç¸½æŸ¥è©¢æ•¸**: {user['total_queries']}
ğŸ“… **åŠ å…¥æ—¥æœŸ**: {user['joined_date'].strftime('%Y-%m-%d')}

ğŸ’¡ **å¯ç”¨åŠŸèƒ½**:
{"âœ… æ¨™æ™®500è‚¡ç¥¨æŸ¥è©¢" if level_config['stocks'] == 'sp500' else ''}
{"âœ… ä¸ƒå·¨é ­æ·±åº¦åˆ†æ" if level_config['stocks'] == 'magnificent7' else ''}
{"âœ… å…¨ç¾è‚¡8000+æ”¯æŸ¥è©¢" if level_config['stocks'] == 'all' else ''}
{"âœ… Max Pain/Gammaåˆ†æ" if level_config['features'] in ['advanced', 'premium'] else ''}

{"ç”³è«‹Pro Beta: /apply_beta" if user['level'] == 'free' else ''}
"""
    
    def generate_welcome_message(self) -> str:
        """ç”Ÿæˆæ­¡è¿ä¿¡æ¯"""
        return """
ğŸ‰ **æ­¡è¿ä½¿ç”¨ Maggie Stock AIï¼**

ğŸš€ **ä¸‰ç¨®æœå‹™ç´šåˆ¥**:

ğŸ†“ **å…è²»ç‰ˆ**:
â€¢ æ¨™æ™®500è‚¡ç¥¨æŸ¥è©¢
â€¢ æ¯æ—¥3æ¬¡é™åˆ¶  
â€¢ åŸºç¤åˆ†æ + AIå»ºè­°

ğŸ’ **Pro Beta** (é™æ™‚å…è²»):
â€¢ ä¸ƒå·¨é ­æ·±åº¦åˆ†æ
â€¢ Max Pain/Gammaåˆ†æ
â€¢ ç„¡é™æŸ¥è©¢
â€¢ åƒ…é™100äººæ¸¬è©¦

ğŸ”¥ **VIPå°ˆæ¥­ç‰ˆ**:
â€¢ å…¨ç¾è‚¡8000+æ”¯
â€¢ å®Œæ•´æœŸæ¬Šåˆ†æ
â€¢ ç±Œç¢¼åˆ†æ
â€¢ Notionæ•´åˆ

ğŸ’¡ **ä½¿ç”¨æ–¹æ³•**:
ç›´æ¥è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼Œä¾‹å¦‚ï¼šAAPL

ğŸ“‹ **æŒ‡ä»¤æ¸…å–®**:
/apply_beta - ç”³è«‹Pro Betaæ¸¬è©¦
/status - æŸ¥çœ‹å€‹äººç‹€æ…‹  
/sp500 - æ¨™æ™®500æ¸…å–®

ğŸ¯ ç«‹å³é–‹å§‹é«”é©—ï¼
"""
    
    def send_telegram_message(self, message: str) -> bool:
        """ç™¼é€Telegramæ¶ˆæ¯"""
        try:
            if not self.telegram_chat_id:
                print("ğŸ“± æ¨¡æ“¬Telegramå›æ‡‰:")
                print("=" * 50)
                print(message)
                print("=" * 50)
                return True
            
            url = f"https://api.telegram.org/bot{self.telegram_token}/sendMessage"
            data = {
                "chat_id": self.telegram_chat_id,
                "text": message,
                "parse_mode": "Markdown"
            }
            
            response = requests.post(url, json=data, timeout=10)
            return response.status_code == 200
            
        except Exception as e:
            print(f"âŒ Telegramç™¼é€éŒ¯èª¤: {e}")
            return False
    
    def run_demo(self):
        """é‹è¡Œæ¼”ç¤º"""
        print("ğŸš€ Maggie Stock AI çµ±ä¸€æ©Ÿå™¨äººæ¼”ç¤º")
        print("=" * 60)
        
        # æ¨¡æ“¬ä¸åŒç”¨æˆ¶
        demo_users = {
            'free_user': 'free',
            'beta_user': 'pro_beta',
            'vip_user': 'vip'
        }
        
        # è¨»å†Šæ¼”ç¤ºç”¨æˆ¶
        for user_id, level in demo_users.items():
            self.register_user(user_id, level)
            if level == 'pro_beta':
                self.pro_beta_users.add(user_id)
        
        # æ¼”ç¤ºæŸ¥è©¢
        test_queries = [
            ('free_user', 'AAPL'),
            ('beta_user', 'NVDA'), 
            ('free_user', 'RBLX'),  # éæ¨™æ™®500
            ('free_user', '/apply_beta'),
        ]
        
        for user_id, query in test_queries:
            print(f"\nğŸ‘¤ ç”¨æˆ¶: {user_id} | æŸ¥è©¢: {query}")
            print("-" * 40)
            response = self.process_message(query, user_id)
            print(response)

def main():
    """ä¸»å‡½æ•¸"""
    try:
        bot = UnifiedStockBot()
        
        if bot.telegram_chat_id:
            # ç™¼é€æ­¡è¿æ¶ˆæ¯
            welcome = bot.generate_welcome_message()
            bot.send_telegram_message(welcome)
        else:
            # æœ¬åœ°æ¼”ç¤º
            bot.run_demo()
            
    except Exception as e:
        print(f"âŒ ç³»çµ±éŒ¯èª¤: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
