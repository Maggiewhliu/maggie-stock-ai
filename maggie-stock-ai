#!/usr/bin/env python3
"""
Maggie Stock AI - å…è²»ç‰ˆæµé‡å…¥å£
æ¨™æ™®500è‚¡ç¥¨æŸ¥è©¢ + æ¯æ—¥3æ¬¡é™åˆ¶ + å‡ç´šå¼•å°
"""
import sys
import requests
import os
import json
import hashlib
from datetime import datetime, timedelta
from typing import Dict, List, Optional

class MaggieStockFree:
    def __init__(self):
        self.telegram_token = os.getenv('TELEGRAM_BOT_TOKEN')
        self.telegram_chat_id = os.getenv('TELEGRAM_CHAT_ID')
        
        # å…è²»ç‰ˆé…ç½®
        self.daily_limit = 3
        self.sp500_symbols = self.load_sp500_list()
        
        # ä»˜è²»ç‰ˆåƒ¹æ ¼
        self.basic_price = "$19.99"
        self.pro_price = "$49.99"
        
        # ç”¨æˆ¶æ•¸æ“šå­˜å„² (ç°¡åŒ–ç‰ˆï¼Œå¯¦éš›æ‡‰ç”¨ç”¨æ•¸æ“šåº«)
        self.user_data = {}
        
        if not self.telegram_token:
            raise ValueError("ç¼ºå°‘ Telegram Bot Token")
    
    def load_sp500_list(self) -> List[str]:
        """åŠ è¼‰æ¨™æ™®500è‚¡ç¥¨ä»£ç¢¼æ¸…å–®"""
        return [
            'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'TSLA', 'META', 'BRK.B',
            'UNH', 'JNJ', 'V', 'PG', 'JPM', 'HD', 'MA', 'PFE', 'BAC', 'ABBV',
            'KO', 'PEP', 'COST', 'DIS', 'ADBE', 'CRM', 'NFLX', 'XOM', 'TMO',
            'VZ', 'ACN', 'DHR', 'LLY', 'NKE', 'QCOM', 'TXN', 'NEE', 'PM',
            'UPS', 'RTX', 'LOW', 'INTU', 'AMD', 'SPGI', 'HON', 'SBUX', 'GS',
            'CVX', 'LIN', 'T', 'UNP', 'SCHW', 'AXP', 'BLK', 'MDT', 'CAT',
            'DE', 'MMM', 'AMT', 'IBM', 'TJX', 'GE', 'MU', 'NOW', 'ISRG',
            'AMAT', 'CI', 'WMT', 'MO', 'GILD', 'COP', 'SO', 'ANTM', 'CVS',
            'FIS', 'PYPL', 'C', 'ZTS', 'MDLZ', 'TGT', 'SYK', 'CSX', 'USB',
            'BMY', 'WM', 'EOG', 'DUK', 'APD', 'CL', 'NSC', 'AON', 'ATVI'
        ]
    
    def get_user_id_from_message(self, message_text: str) -> str:
        """å¾æ¶ˆæ¯ä¸­æå–ç”¨æˆ¶ID (ç°¡åŒ–ç‰ˆ)"""
        # å¯¦éš›æ‡‰ç”¨ä¸­å¾Telegram APIç²å–ç”¨æˆ¶ID
        return hashlib.md5(message_text.encode()).hexdigest()[:8]
    
    def check_user_limit(self, user_id: str) -> tuple[bool, int]:
        """æª¢æŸ¥ç”¨æˆ¶æ¯æ—¥æŸ¥è©¢é™åˆ¶"""
        today = datetime.now().date()
        
        if user_id not in self.user_data:
            self.user_data[user_id] = {
                'last_date': today,
                'daily_count': 0,
                'total_queries': 0
            }
        
        user = self.user_data[user_id]
        
        # é‡ç½®æ¯æ—¥è¨ˆæ•¸
        if user['last_date'] != today:
            user['daily_count'] = 0
            user['last_date'] = today
        
        remaining = self.daily_limit - user['daily_count']
        can_query = remaining > 0
        
        return can_query, remaining
    
    def update_user_count(self, user_id: str):
        """æ›´æ–°ç”¨æˆ¶æŸ¥è©¢è¨ˆæ•¸"""
        if user_id in self.user_data:
            self.user_data[user_id]['daily_count'] += 1
            self.user_data[user_id]['total_queries'] += 1
    
    def get_stock_data(self, symbol: str) -> Dict:
        """ç²å–è‚¡ç¥¨åŸºç¤æ•¸æ“š"""
        try:
            url = f"https://query1.finance.yahoo.com/v8/finance/chart/{symbol}"
            headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}
            
            response = requests.get(url, headers=headers, timeout=10)
            data = response.json()
            
            if not data.get('chart') or not data['chart'].get('result'):
                return {'error': 'è‚¡ç¥¨ä»£ç¢¼ç„¡æ•ˆæˆ–æ•¸æ“šä¸å¯ç”¨'}
            
            result = data['chart']['result'][0]
            meta = result['meta']
            
            # åŸºç¤æ•¸æ“š
            current_price = meta['regularMarketPrice']
            previous_close = meta['previousClose']
            change = current_price - previous_close
            change_percent = (change / previous_close) * 100
            
            # ç²å–ä¸€äº›æ­·å²æ•¸æ“šç”¨æ–¼ç°¡å–®æŠ€è¡“æŒ‡æ¨™
            quotes = result.get('indicators', {}).get('quote', [{}])[0]
            closes = [p for p in quotes.get('close', []) if p is not None]
            
            # ç°¡å–®ç§»å‹•å¹³å‡
            sma_20 = sum(closes[-20:]) / 20 if len(closes) >= 20 else None
            sma_50 = sum(closes[-50:]) / 50 if len(closes) >= 50 else None
            
            return {
                'symbol': symbol,
                'company_name': meta.get('longName', symbol),
                'current_price': current_price,
                'previous_close': previous_close,
                'change': change,
                'change_percent': change_percent,
                'volume': meta.get('regularMarketVolume', 0),
                'market_cap': meta.get('marketCap'),
                'day_high': meta.get('regularMarketDayHigh'),
                'day_low': meta.get('regularMarketDayLow'),
                'sma_20': sma_20,
                'sma_50': sma_50,
                'status_emoji': self.get_status_emoji(change_percent)
            }
        except Exception as e:
            return {'error': f'æ•¸æ“šç²å–å¤±æ•—: {str(e)}'}
    
    def get_status_emoji(self, change_percent: float) -> str:
        """æ ¹æ“šæ¼²è·Œå¹…è¿”å›ç‹€æ…‹è¡¨æƒ…"""
        if change_percent >= 2:
            return 'ğŸ”¥'
        elif change_percent >= 0.5:
            return 'ğŸ“ˆ'
        elif change_percent >= 0:
            return 'ğŸ“Š'
        elif change_percent >= -2:
            return 'ğŸ“‰'
        else:
            return 'ğŸ’¥'
    
    def generate_upgrade_message(self, trigger_type: str = "limit") -> str:
        """ç”Ÿæˆå‡ç´šæ¨å»£ä¿¡æ¯"""
        if trigger_type == "limit":
            return f"""
ğŸš« **å…è²»ç‰ˆæ¯æ—¥æŸ¥è©¢å·²é”ä¸Šé™ (3æ¬¡)**

ğŸ’ **å‡ç´šVIPï¼Œè§£é–å¼·å¤§åŠŸèƒ½ï¼**

ğŸ¥ˆ **VIPåŸºç¤ç‰ˆ {self.basic_price}/æœˆ**:
âœ… å…¨ç¾è‚¡8000+æ”¯ç„¡é™æŸ¥è©¢
âœ… æ–°è‚¡/IPOå¯¦æ™‚è¿½è¹¤  
âœ… æŠ€è¡“åˆ†æ (RSI/MACD/å¸ƒæ—å¸¶)
âœ… å³æ™‚æ–°èæ•´åˆèˆ‡AIæ‘˜è¦
âœ… ç„¡å»¶é²å¯¦æ™‚æ•¸æ“š

ğŸ¥‡ **VIPå°ˆæ¥­ç‰ˆ {self.pro_price}/æœˆ**:
âœ… åŸºç¤ç‰ˆæ‰€æœ‰åŠŸèƒ½
âœ… **æœŸæ¬Šæ·±åº¦åˆ†æ** (Max Pain/Gamma/IV)
âœ… **ç±Œç¢¼åˆ†æ** (ä¸»åŠ›é€²å‡º/å¤§æˆ¶æ¯”ä¾‹)  
âœ… **NotionæŠ•è³‡çµ„åˆé¢æ¿**
âœ… **æ™ºèƒ½åƒ¹æ ¼è­¦å ±**
âœ… **å¤šå¹³å°åŒæ­¥æ¨é€**

ğŸ”¥ **é™æ™‚å„ªæƒ **: å‰100åç”¨æˆ¶äº«5æŠ˜å„ªæƒ ï¼

ç«‹å³å‡ç´š: [å‡ç´šé€£çµ]
å®¢æœè«®è©¢: @maggie_stock_support
"""
        elif trigger_type == "non_sp500":
            return f"""
ğŸš« **å…è²»ç‰ˆåƒ…æ”¯æŒæ¨™æ™®500è‚¡ç¥¨æŸ¥è©¢**

æ‚¨æŸ¥è©¢çš„è‚¡ç¥¨ä¸åœ¨æ¨™æ™®500ç¯„åœå…§ã€‚

ğŸ’ **å‡ç´šVIPåŸºç¤ç‰ˆ {self.basic_price}/æœˆ**
ğŸŒ è§£é–å…¨ç¾è‚¡8000+æ”¯è‚¡ç¥¨æŸ¥è©¢ï¼

åŒ…å«ï¼š
âœ… NASDAQå…¨éƒ¨è‚¡ç¥¨  
âœ… NYSEå®Œæ•´è¦†è“‹
âœ… æ–°è‚¡/IPOå¯¦æ™‚è¿½è¹¤
âœ… æŠ€è¡“åˆ†ææŒ‡æ¨™
âœ… ç„¡é™æŸ¥è©¢æ¬¡æ•¸

ğŸ¯ **ç†±é–€éæ¨™æ™®500è‚¡ç¥¨**:
RBLX, PLTR, COIN, HOOD, RIVN, LCID...

ç«‹å³å‡ç´š: [å‡ç´šé€£çµ]
"""
        else:
            return f"""
ğŸ’¡ **ç™¼ç¾æ›´å¤šå°ˆæ¥­åŠŸèƒ½**

å…è²»ç‰ˆå¾ˆæ£’ï¼Œä½†VIPç‰ˆæ›´å¼·å¤§ï¼

ğŸ¥‡ **VIPå°ˆæ¥­ç‰ˆç¨æœ‰**:
ğŸ¯ **Max Pain Theory** - é æ¸¬ä¸»åŠ›æ“æ§ç›®æ¨™
âš¡ **Gamma Exposure** - è­˜åˆ¥æ”¯æ’é˜»åŠ›ç‰†  
ğŸ“Š **IV Crushåˆ†æ** - é¿é–‹æœŸæ¬Šé™·é˜±
ğŸ§  **ç±Œç¢¼åˆ†æ** - è¿½è¹¤ä¸»åŠ›è³‡é‡‘å‹•å‘

ğŸ’¼ **å°ˆæ¥­æŠ•è³‡è€…çš„é¸æ“‡**
æ¯å¤©çœä¸‹2æ¯å’–å•¡éŒ¢ï¼Œç²å¾—è¯çˆ¾è¡—ç´šåˆ¥åˆ†æï¼

å…è²»è©¦ç”¨7å¤©: [è©¦ç”¨é€£çµ]
"""
    
    def format_stock_response(self, stock_data: Dict, remaining_queries: int) -> str:
        """æ ¼å¼åŒ–è‚¡ç¥¨æŸ¥è©¢å›æ‡‰"""
        if 'error' in stock_data:
            return f"âŒ {stock_data['error']}"
        
        # åŸºç¤ä¿¡æ¯
        response = f"""
{stock_data['status_emoji']} **{stock_data['company_name']} ({stock_data['symbol']})**

ğŸ’° **åƒ¹æ ¼è³‡è¨Š**
ç•¶å‰åƒ¹æ ¼: ${stock_data['current_price']:.2f}
æ¼²è·Œ: {stock_data['change']:+.2f} ({stock_data['change_percent']:+.2f}%)
æˆäº¤é‡: {stock_data['volume']:,}
"""
        
        # å¸‚å€¼ä¿¡æ¯
        if stock_data.get('market_cap'):
            market_cap_b = stock_data['market_cap'] / 1e9
            response += f"å¸‚å€¼: ${market_cap_b:.1f}B\n"
        
        # åƒ¹æ ¼å€é–“
        response += f"""
ğŸ“ˆ **ä»Šæ—¥å€é–“**
æœ€é«˜: ${stock_data.get('day_high', 0):.2f}
æœ€ä½: ${stock_data.get('day_low', 0):.2f}
"""
        
        # æŠ€è¡“æŒ‡æ¨™ (å…è²»ç‰ˆç°¡åŒ–)
        if stock_data.get('sma_20') and stock_data.get('sma_50'):
            trend = "ğŸ“ˆ å¤šé ­" if stock_data['current_price'] > stock_data['sma_20'] > stock_data['sma_50'] else "ğŸ“‰ ç©ºé ­"
            response += f"""
ğŸ“Š **æŠ€è¡“é¢**
20æ—¥å‡ç·š: ${stock_data['sma_20']:.2f}
50æ—¥å‡ç·š: ${stock_data['sma_50']:.2f}
è¶¨å‹¢: {trend}
"""
        
        # æŸ¥è©¢ç‹€æ…‹
        response += f"""
ğŸ“± **å…è²»ç‰ˆç‹€æ…‹**
ä»Šæ—¥å‰©é¤˜æŸ¥è©¢: {remaining_queries}æ¬¡
å‡ç´šVIPäº«ç„¡é™æŸ¥è©¢: [å‡ç´šé€£çµ]
"""
        
        # å‡ç´šæç¤º (è»Ÿæ€§æ¨å»£)
        if remaining_queries <= 1:
            response += f"""
ğŸ’¡ **æé†’**: ä»Šæ—¥æŸ¥è©¢å³å°‡ç”¨å®Œ
VIPåŸºç¤ç‰ˆæ¯æœˆåƒ…éœ€ {self.basic_price}ï¼Œäº«å—ç„¡é™æŸ¥è©¢ï¼
"""
        
        return response
    
    def process_stock_query(self, symbol: str, user_id: str) -> str:
        """è™•ç†è‚¡ç¥¨æŸ¥è©¢è«‹æ±‚"""
        symbol = symbol.upper().strip()
        
        # æª¢æŸ¥æ˜¯å¦ç‚ºæ¨™æ™®500è‚¡ç¥¨
        if symbol not in self.sp500_symbols:
            upgrade_msg = self.generate_upgrade_message("non_sp500")
            return f"""
ğŸš« **è©²è‚¡ç¥¨ä¸åœ¨å…è²»ç‰ˆç¯„åœå…§**

å…è²»ç‰ˆåƒ…æ”¯æŒæ¨™æ™®500è‚¡ç¥¨æŸ¥è©¢ã€‚
æ‚¨æŸ¥è©¢çš„ **{symbol}** éœ€è¦å‡ç´šVIPç‰ˆæœ¬ã€‚

{upgrade_msg}

ğŸ’¡ **å…è²»ç‰ˆæ”¯æŒçš„ç†±é–€è‚¡ç¥¨**:
AAPL, MSFT, GOOGL, AMZN, NVDA, TSLA, META
è¼¸å…¥ /list æŸ¥çœ‹å®Œæ•´æ¨™æ™®500æ¸…å–®
"""
        
        # æª¢æŸ¥æ¯æ—¥æŸ¥è©¢é™åˆ¶
        can_query, remaining = self.check_user_limit(user_id)
        if not can_query:
            return self.generate_upgrade_message("limit")
        
        # ç²å–è‚¡ç¥¨æ•¸æ“š
        stock_data = self.get_stock_data(symbol)
        if 'error' in stock_data:
            return f"âŒ {stock_data['error']}\n\nè«‹ç¢ºèªè‚¡ç¥¨ä»£ç¢¼æ­£ç¢ºï¼Œæˆ–è¼¸å…¥ /help æŸ¥çœ‹ä½¿ç”¨èªªæ˜"
        
        # æ›´æ–°ç”¨æˆ¶æŸ¥è©¢è¨ˆæ•¸
        self.update_user_count(user_id)
        remaining -= 1
        
        # æ ¼å¼åŒ–å›æ‡‰
        return self.format_stock_response(stock_data, remaining)
    
    def generate_welcome_message(self) -> str:
        """ç”Ÿæˆæ­¡è¿ä¿¡æ¯"""
        return f"""
ğŸ‰ **æ­¡è¿ä½¿ç”¨ Maggie Stock AIï¼**

ğŸ†“ **å…è²»ç‰ˆåŠŸèƒ½**:
ğŸ“Š æ¨™æ™®500è‚¡ç¥¨å¯¦æ™‚æŸ¥è©¢
ğŸ“ˆ åŸºç¤æŠ€è¡“åˆ†æ
ğŸ’° å¸‚å€¼å’Œåƒ¹æ ¼è³‡è¨Š
â° æ¯æ—¥3æ¬¡å…è²»æŸ¥è©¢

ğŸ’¡ **ä½¿ç”¨æ–¹æ³•**:
ç›´æ¥è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼Œä¾‹å¦‚ï¼š
â€¢ `AAPL` - æŸ¥è©¢è˜‹æœ
â€¢ `TSLA` - æŸ¥è©¢ç‰¹æ–¯æ‹‰  
â€¢ `NVDA` - æŸ¥è©¢è‹±å‰é”

ğŸ“‹ **å¸¸ç”¨æŒ‡ä»¤**:
/help - ä½¿ç”¨èªªæ˜
/list - æ¨™æ™®500æ¸…å–®
/upgrade - å‡ç´šVIP
/status - æŸ¥è©¢ç‹€æ…‹

ğŸ¯ **ç†±é–€è‚¡ç¥¨**: AAPL, TSLA, NVDA, MSFT, GOOGL

ğŸ’ æƒ³è¦æ›´å¤šåŠŸèƒ½ï¼Ÿå‡ç´šVIPäº«å—ï¼š
â€¢ å…¨ç¾è‚¡8000+æ”¯æŸ¥è©¢
â€¢ æœŸæ¬ŠMax Painåˆ†æ  
â€¢ ç±Œç¢¼åˆ†æ
â€¢ ç„¡é™æŸ¥è©¢æ¬¡æ•¸

ç«‹å³é–‹å§‹æŸ¥è©¢å§ï¼ğŸ“ˆ
"""
    
    def generate_help_message(self) -> str:
        """ç”Ÿæˆå¹«åŠ©ä¿¡æ¯"""
        return f"""
ğŸ“š **Maggie Stock AI ä½¿ç”¨æŒ‡å—**

ğŸ” **æŸ¥è©¢æ–¹æ³•**:
ç›´æ¥è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼ˆç„¡éœ€/ç¬¦è™Ÿï¼‰
ä¾‹å¦‚ï¼šAAPL, TSLA, MSFT

ğŸ“Š **å…è²»ç‰ˆé™åˆ¶**:
â€¢ åƒ…æ”¯æŒæ¨™æ™®500è‚¡ç¥¨
â€¢ æ¯æ—¥3æ¬¡æŸ¥è©¢é™åˆ¶
â€¢ åŸºç¤æŠ€è¡“åˆ†æ

ğŸ’ **VIPç‰ˆæœ¬åŠŸèƒ½**:
ğŸ¥ˆ åŸºç¤ç‰ˆ {self.basic_price}/æœˆ:
â€¢ å…¨ç¾è‚¡8000+æ”¯æŸ¥è©¢
â€¢ æŠ€è¡“æŒ‡æ¨™å®Œæ•´åˆ†æ
â€¢ æ–°è‚¡/IPOè¿½è¹¤

ğŸ¥‡ å°ˆæ¥­ç‰ˆ {self.pro_price}/æœˆ:
â€¢ Max Pain/Gammaåˆ†æ
â€¢ ç±Œç¢¼åˆ†æ
â€¢ æ™ºèƒ½è­¦å ±

ğŸ¤ **å®¢æœæ”¯æŒ**:
å•é¡Œå›å ±: @maggie_stock_support
åŠŸèƒ½å»ºè­°: feedback@maggiestock.ai

ğŸ’¡ è¼¸å…¥ä»»ä½•æ¨™æ™®500è‚¡ç¥¨ä»£ç¢¼é–‹å§‹é«”é©—ï¼
"""
    
    def send_telegram_message(self, message: str) -> bool:
        """ç™¼é€æ¶ˆæ¯åˆ°Telegram"""
        try:
            if not self.telegram_chat_id:
                print("ğŸ“± Telegram Chat ID æœªè¨­ç½®ï¼Œåƒ…è¼¸å‡ºåˆ°æ§åˆ¶å°")
                print("=" * 50)
                print(message)
                print("=" * 50)
                return True
            
            telegram_url = f"https://api.telegram.org/bot{self.telegram_token}/sendMessage"
            telegram_data = {
                "chat_id": self.telegram_chat_id,
                "text": message,
                "parse_mode": "Markdown"
            }
            
            response = requests.post(telegram_url, json=telegram_data, timeout=10)
            return response.status_code == 200
            
        except Exception as e:
            print(f"âŒ Telegram ç™¼é€éŒ¯èª¤: {e}")
            return False
    
    def run_demo(self):
        """é‹è¡Œæ¼”ç¤º"""
        print("ğŸš€ Maggie Stock AI å…è²»ç‰ˆæ¼”ç¤º")
        print("=" * 50)
        
        # æ¨¡æ“¬ç”¨æˆ¶æŸ¥è©¢
        demo_user = "demo_user_001"
        
        # æ­¡è¿æ¶ˆæ¯
        welcome = self.generate_welcome_message()
        print("ğŸ“± æ­¡è¿æ¶ˆæ¯:")
        print(welcome)
        print()
        
        # æ¨¡æ“¬æŸ¥è©¢
        queries = ["AAPL", "TSLA", "NVDA", "MSFT"]  # ç¬¬4å€‹æœƒè§¸ç™¼é™åˆ¶
        
        for i, symbol in enumerate(queries, 1):
            print(f"ğŸ” æŸ¥è©¢ {i}: {symbol}")
            result = self.process_stock_query(symbol, demo_user)
            print(result)
            print("-" * 30)

def main():
    """ä¸»å‡½æ•¸"""
    try:
        bot = MaggieStockFree()
        
        # å¦‚æœæœ‰ç’°å¢ƒè®Šæ•¸ï¼Œç™¼é€æ­¡è¿æ¶ˆæ¯
        if bot.telegram_chat_id:
            welcome = bot.generate_welcome_message()
            bot.send_telegram_message(welcome)
        else:
            # æœ¬åœ°æ¼”ç¤º
            bot.run_demo()
            
    except Exception as e:
        print(f"âŒ ç³»çµ±éŒ¯èª¤: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
